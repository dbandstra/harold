def Instrument:
    sample_rate: constant,
    freq: waveform,
    color: constant,
begin
    let freq =
        freq * (1 + 0.02 * SineOsc(sample_rate, freq=4, phase=0))

    out Filter(input=PulseOsc(color, sample_rate, freq), filter_type='low_pass', cutoff=0.3, resonance=0)
end

def Echoes:
    input: waveform,
    echo_volume: constant,
begin
    out delay 11025 begin
        let result = input + feedback * echo_volume

        out result
        feedback Filter(input=result, filter_type='low_pass', cutoff=0.8, resonance=0)
    end
end

def OuterInstrument:
    sample_rate: constant,
    freq: cob,
    note_on: boolean,
begin
    let input = Instrument(sample_rate, freq=freq*0.5, color=0.7) * Gate(note_on)

    out Echoes(input, echo_volume=0.5)
end
